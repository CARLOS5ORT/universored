<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Voice Master Pro</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
<script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

<style>
body{
    margin:0;
    background:#050508;
    color:#00f2ff;
    font-family:'Segoe UI',sans-serif;
    overflow:hidden;
}
.hidden{display:none}
#setup-panel{
    position:absolute;top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:rgba(20,20,40,.95);
    padding:35px;
    border:2px solid #00f2ff;
    border-radius:18px;
    text-align:center;
    width:320px;
    z-index:10;
}
#footer-controls{
    position:absolute;bottom:0;width:100%;
    background:rgba(0,0,0,.95);
    padding:10px 0 20px;
}
#progress-container{
    width:90%;height:10px;
    background:#222;margin:10px auto;
    border-radius:5px;cursor:pointer;
}
#progress-bar{height:100%;width:0;background:#00f2ff}
#controls-row{
    display:flex;justify-content:center;gap:10px;
}
.btn{
    background:transparent;
    border:1px solid #00f2ff;
    color:#00f2ff;
    padding:7px 16px;
    border-radius:18px;
    font-size:11px;
    cursor:pointer;
}
.btn:hover{background:#00f2ff;color:#000}
#hud{
    position:absolute;top:20px;right:20px;
    text-align:right;
}
</style>
</head>

<body>

<div id="setup-panel">
<h1>VOICE MASTER</h1>
<p>Entrenamiento vocal inteligente</p>
<input type="file" id="audioFile" accept="audio/*"><br><br>
<select id="mode">
<option value="game">ðŸŽ® Juego</option>
<option value="train">ðŸŽ¼ Entrenamiento</option>
</select><br><br>
<button class="btn" onclick="startAll()" style="background:#00f2ff;color:#000">
CARGAR Y ANALIZAR
</button>
</div>

<div id="footer-controls" class="hidden">
<div id="progress-container" onclick="seek(event)">
<div id="progress-bar"></div>
</div>
<div id="controls-row">
<button class="btn" onclick="jump(-10)">-10s</button>
<button class="btn" id="playBtn" onclick="toggle()">PAUSA</button>
<button class="btn" onclick="jump(10)">+10s</button>
<div id="time" style="width:120px;color:#888;font-family:monospace"></div>
</div>
</div>

<div id="hud" class="hidden">
<div id="note" style="font-size:56px">--</div>
<div id="status"></div>
<div id="stats"></div>
</div>

<script>
let song, mic, fft, pitch, amp;
let ready=false, freqUser=0, smoothFreq=0;
let alpha=0.2;
let bars=[];
let score=0;
let frames=0, tuned=0;
let mode="game";

const notes=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

function setup(){
    createCanvas(windowWidth,windowHeight);
}

async function startAll(){
    let file=document.getElementById("audioFile").files[0];
    if(!file)return;
    mode=document.getElementById("mode").value;

    document.getElementById("setup-panel").classList.add("hidden");
    document.getElementById("footer-controls").classList.remove("hidden");
    document.getElementById("hud").classList.remove("hidden");

    await getAudioContext().resume();

    song=loadSound(URL.createObjectURL(file),()=>{
        fft=new p5.FFT(0.9,2048);
        fft.setInput(song);

        mic=new p5.AudioIn();
        mic.start(()=>{
            amp=new p5.Amplitude();
            amp.setInput(mic);

            const model=
            "https://raw.githubusercontent.com/ml5js/ml5-data-and-models/main/models/pitch-detection/crepe/";
            pitch=ml5.pitchDetection(model,getAudioContext(),mic.stream,()=>{
                ready=true;
                song.play();
            });
        });
    });
}

function draw(){
    background(5,5,15);
    if(!ready)return;

    drawGrid();
    let now=song.currentTime();

    let fSong=detectSongPitch();
    if(fSong && mode==="game"){
        if(bars.length==0 || now-bars.at(-1).t>0.15){
            bars.push({y:freqToY(fSong),t:now,hit:false,f:fSong});
        }
    }

    pitch.getPitch((e,f)=>{
        if(amp.getLevel()<0.02){freqUser=0;return;}
        smoothFreq=alpha*(f||0)+(1-alpha)*smoothFreq;
        freqUser=smoothFreq;
    });

    if(freqUser>0 && fSong){
        let cents=1200*Math.log2(freqUser/fSong);
        frames++;
        if(Math.abs(cents)<40)tuned++;

        let color="#00ff96";
        let status="AFINADO";
        if(cents<-40){color="#ff4444";status="BAJO";}
        if(cents>40){color="#4488ff";status="ALTO";}

        fill(color);noStroke();
        ellipse(width/2,freqToY(freqUser),40);

        document.getElementById("status").innerText=status;
    }

    if(mode==="game"){
        for(let b of bars){
            let x=width/2+(b.t-now)*400;
            if(x<80||x>width)continue;
            stroke(b.hit?"#00ff96":"#ff00ff");
            strokeWeight(10);
            line(x,b.y,x+40,b.y);

            if(!b.hit && freqUser>0){
                let cents=1200*Math.log2(freqUser/b.f);
                if(Math.abs(cents)<40 && Math.abs(x-width/2)<20){
                    b.hit=true;
                    score+=10;
                }
            }
        }
    }

    if(freqUser>0){
        let midi=Math.round(12*Math.log2(freqUser/440)+69);
        document.getElementById("note").innerText=notes[midi%12];
    }else document.getElementById("note").innerText="--";

    updateUI();
}

function detectSongPitch(){
    let w=fft.waveform();
    let best=-1,max=0;
    for(let o=30;o<900;o++){
        let c=0;
        for(let i=0;i<w.length-o;i++)c+=w[i]*w[i+o];
        if(c>max){max=c;best=o;}
    }
    return best>0?getAudioContext().sampleRate/best:null;
}

function drawGrid(){
    for(let i=36;i<84;i++){
        let f=440*Math.pow(2,(i-69)/12);
        let y=freqToY(f);
        stroke(255,10);line(80,y,width,y);
        noStroke();fill(0,242,255,100);
        text(notes[i%12],30,y);
    }
    stroke(0,242,255,40);line(80,0,80,height);
}

function freqToY(f){
    return map(Math.log(f),Math.log(80),Math.log(1100),height-150,60);
}

function updateUI(){
    let c=song.currentTime(),d=song.duration();
    document.getElementById("progress-bar").style.width=(c/d*100)+"%";
    document.getElementById("time").innerText=floor(c)+" / "+floor(d);
    document.getElementById("stats").innerText=
    `Score: ${score} | Afinado: ${frames?Math.round(tuned/frames*100):0}%`;
}

function toggle(){
    if(song.isPlaying()){song.pause();playBtn.innerText="PLAY";}
    else{song.play();playBtn.innerText="PAUSA";}
}
function jump(s){song.jump(constrain(song.currentTime()+s,0,song.duration()));}
function seek(e){
    let r=e.target.getBoundingClientRect();
    song.jump((e.clientX-r.left)/r.width*song.duration());
}
function windowResized(){resizeCanvas(windowWidth,windowHeight);}
</script>
</body>
</html>

